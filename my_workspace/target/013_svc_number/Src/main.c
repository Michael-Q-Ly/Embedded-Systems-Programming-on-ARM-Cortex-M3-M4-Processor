/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */

/*
 * Exercise:    Write a program to execure SVC instruction from thread mode,
*               implement the SVC handler to print theSVC number used. Also,
*               increment the SVC number by 4 and return it to the thread mode code
*               and print it.
*
*               Hints:
*               1)  Write a main() function where you should execute theSVC
*                   instruction with an argument. Let's say SVC #0x5
*               2)  Implement the SVC handler.
*               3)	In the SVC handler, extract the SVC number and print it using printf.
*               4)	Increment the SVC number by 4 and return it to the thread mode.
*/


#include <stdint.h>
#include <stdio.h>

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
  #warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

/* Function Prototypes */
extern void initialise_monitor_handles(void) ;									// Debugger
void SVC_Handler_C(uint32_t *pBaseOfStackFrame) ;

int main(void) {
	initialise_monitor_handles() ;                                          	// Debugger
 
#if 0
    __asm ("SVC #0x08") ;
#else
    __asm ("SVC #25") ;                                                         // Set SVC and then enter handler
#endif

    // register uint32_t data __asm ("R0") ;                                    // We need to save R0 into a C variable. (Not recommended
                                                                                // because this is just a recommendation to associate R0
                                                                                // with the C variable data. If R0 not free, this will fail.
    
    uint32_t data ;                                                             // It is recommended to use inline assembly with
                                                                                // input and output arguments with inline assembly
    __asm volatile ("MOV %0, R0": "=r"(data) : : ) ;                            // Use volatile so compiler does not optimize this line.

    printf("Data = %ld\n", data) ;

    /* Loop forever */
	for(;;);
}

__attribute__ ((naked)) void SVC_Handler(void) {                                // 1)
    __asm ("MRS R0, MSP") ;                                                     // R0 is copied into *pBaseofStackFrame      
    __asm ("B SVC_Handler_C") ;
}


void SVC_Handler_C(uint32_t *pBaseOfStackFrame) {
    printf("In SVC handler\n") ;

    uint8_t *pReturn_addr = (uint8_t*) (pBaseOfStackFrame[6]) ;
    // 1)   Get the value of the MSP using a naked function as to not corrupt
    //      the sp.

    // 2)   Decrement the return address by 2 to point to opcode of the SVC
    //      instruction in the program memory
    pReturn_addr -= 2 ;

    // 3)   Extract the SVC number (LSByte of the opcode)
    uint8_t svc_number = *pReturn_addr ;

    printf("SVC number is: %d\n", svc_number) ;
    
    // 4) Increment the SVC number by 4 and return it to thread mode
    svc_number += 4 ;

    pBaseOfStackFrame[0] = svc_number ;                                         // To return to thread mode, we know that we
                                                                                // are pointing to the start of the stack pointer
                                                                                // so we set the start of sp to the svc number
}
